name: Publish Python üêç distributions üì¶ to PyPI and TestPyPI
on: 
  workflow_dispatch:
  push:
    branches:
      feature/release-publish-workflow

jobs:
  template-generation:
    name: 'Generate Template'
    runs-on: [self-hosted, linux, normal-ephemeral]
    steps:
      - name: 'Check out code'
        uses: actions/checkout@v3

      - name: 'Install Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 'Install cookiecutter'
        run: pip install cookiecutter

      - name: 'Install Poetry'
        run: curl -sSL https://install.python-poetry.org | python3 - --version 1.3.2

      - name: 'Generate template'
        run: cookiecutter --no-input . project_name='Test Project'

      - name: 'Generate lock file'
        run: poetry -C ./test-project lock

      - name: 'Cache generated project'
        uses: actions/cache@v3
        with:
          path: ./test-project
          key: test-project-${{ github.run_id }}

  template-tests-release-publish:
    name: 'Test Release Publish Python üêç distributions üì¶ to TestPyPI'
    needs: template-generation
    runs-on: [self-hosted, normal-ephemeral]
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    steps:
      - name: 'Install Python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: 'Install Poetry'
        run: curl -sSL https://install.python-poetry.org | python3 - --version 1.3.2

      - name: 'Restore generated project'
        uses: actions/cache@v3
        with:
          path: ./test-project
          key: test-project-${{ github.run_id }}
      
      - name: 'Build & Package'
        run: |
          make all
          pip wheel .
      
      - name: Publish distribution üì¶ to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
        